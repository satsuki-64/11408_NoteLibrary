## 10.1 文件系统的层次结构
**概述**
+ 用户接口：
	+ 文件系统需要向上层的用户提供一些简单易用的功能接口。这层就是用于处理用户发出的系统调用请求 (Read、Write、open、Close 等系统调用)；
+ 文件目录系统：
	+ 用户是通过文件路径来访问文件的，因此这一层需要根据用户给出的文件路径战到相应的 FCB 或索引结点；
+ 存取控制模块：
	+ 所有和目录、目录项相关的管理工作都在本层完成，如: 管理活跃的文件目录表、管理打开文件表等；
+ 逻辑文件系统与文件信息缓冲区：
	+ 用户指明想要访问文件记录号这一层需要将记录号转换为对应的逻辑地址
+ 物理文件系统：
	+ 这一层需要把上一层提供的文件逻辑地址转换为实际的物理地址
+ 辅助分配模块：
	+ 负责文件存储空间的管理即负责分配和回收存储空间
+ 设备管理模块：
	+ 直接与硬件交互，负责和硬件直接相关的一些管理工作。如: 分配设备、分配设备缓冲区、磁盘调度、启动设备、释放设备等
+ 图示：
	+ ![[Pasted image 20240412155344.png]]

## 10.2 文件系统的全局结构
**文件系统在外存中的建立**
+ 概述：
	+ 文件系统如何再外盘中逐渐建立；
+ 第一步：物理格式化
	+ 1. 低级格式化--划分扇区，检测坏扇区；
	+ 2. 检测到坏扇区后，用备用扇区替换坏扇区；
	+ ![[Pasted image 20240412155931.png]]
+ 第二步：高级格式化
	+ 逻辑格式化后，磁盘分区 (分卷 Volume)，完成各分区的文件系统初始化；
	+ 注意：逻辑格式化后，灰色部分就有实际数据了，白色部分还没有数据；
	+ 位视图：判断哪些盘块是否空闲；
	+ 超级块：迅速的找到若干个空闲的盘块；
	+ 索引区（i 节点区）：存放若干的索引节点；
		+ 通过一个索引结点的下标，迅速的定位到一个索引节点；
	+ 根目录：
	+ ![[Pasted image 20240412155943.png]]

**文件系统在内存中的结构**
+ 内核去：
	+ 目录缓存：最近访问过的目录文件的数据，会被放在目录的缓存中；
	+ 系统打开文件表：整个 OS 只有一张；
	+ 用户打开文件表：每个用户一张；
+ 过程：
	+ 1. Open 调用打开目录，找到目录 M，读入主存，放入目录 M 缓存 -> 检查目录项；
	+ 2. 找到目标文件的 FCB，复制到系统打开文件表，表示这个文件被打开，设置打开计数为 1；
	+ 3. 在进程打开文件表中新建一个条目，并返回文件描述符，并且建立一个指向系统打开文件表；
	+ 4. 用户根据 fd 文件描述符，此时可以执行操作，如 `read(fd)`，在进程打开文件表中找到目标条目，然后根据索引信息，从系统打开文件表找到目标文件的 PCB，然后在找到目标文件；
+ 图示：
	+ ![[Pasted image 20240412160321.png]]

## 10.3 虚拟文件系统和文件系统的挂载
### 10.3.1 普通文件系统
**普通文件系统**
+ 概述：
	+ 不同的硬件设备可能存在不同的文件系统，因此其定义的各种接口可能不同；
	+ 此时当用户想要使用不同的硬件中的文件系统打开文件时，此时需要使用不同的函数代码；
	+ 因此**操作系统内核需要为上层用户进程提供统一标准的系统调用接口，屏蔽底层具体文件系统的实现差异**；
+ 图示：
	+ ![[Pasted image 20240412160941.png]]

### 10.3.2 虚拟文件系统
**虚拟文件系统**
+ 概述：
	+ 操作系统内核需要为上层用户进程提供统一标准的系统调用接口，屏蔽底层具体文件系统的实现差异；
+ 要求：
	+ VFS 要求下层的文件系统必须**实现某些规定的函数功能**；
		+ 要求底层的文件系统必须支持如: open/read/write 的系统调用标准；
	+ 一个新的文件系统想要在某操作系统上被使用，就必须满足该操作系统 VFS 的要求；
+ 图示：
	+ ![[Pasted image 20240412161309.png]]

**对 VFS 的改进**
+ 问题：
	+ 不同的文件系统，表示文件数据结构各不相同打开文件后，其在内存中的表示就不同；
	+ 对于虚拟文件系统，若来自 UFS 文件系统的：
		+ ![[Pasted image 20240412161435.png]]
	+ 来自 FAT 的：
		+ ![[Pasted image 20240412161448.png]]
+ 改进：vnode 结点：
	+ 概述：
		+ 不管来自什么文件系统，相关的信息都存进 vnode 当中；
		+ 每打开一个文件，VFS 就在主存中新建一个 vnode，用统一的数据结构表示文件，无论该文件存储在哪个文件系统；
		+ 打开文件后，创建 vnode，并将文件信息复制到 vnode 中，vnode 的功能指针指向具体文件系统的函数功能；
	+ 函数功能指针：
		+ 函数功能指针存储了指向不同文件系统提供的函数功能；
		+ 比如当需要使用 FAT 中的 read 调用时，会访问 vnode 中的函数功能指针，找到指向 FAT 的函数功能中的 read 函数；
	+ ![[Pasted image 20240412161538.png]]
+ 注意：   
	+ vnode 只存在于主存中，而 node 既会被调入主存，也会在外存中存储；

### 10.3.3 文件系统的挂载
**什么是挂载**
+ 概述：
	+ 文件系统安装/装载 `->` 如何将一个文件系统挂载到操作系统中；
+ 实现：
	+ 1. 在挂载表中注册：在 VFS 中注册新挂载的文件系统内存中的挂载表 (mounttable)，其包含每个文件系统的相关信息，包括文件系统类型、容量大小等；
	+ 2. 提供函数地址：新挂载的文件系统，要向 VFS 提供一个函数地址列表，如 read、write 等函数的地址；
	+ 3. 加到挂载点：将新文件系统加到挂载点 (mountpoint)，也就是将新文件系统挂载在某个父目录下；
+ 图示：
	+ ![[Pasted image 20240412162049.png]]